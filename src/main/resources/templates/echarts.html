<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Movie Charts</title>
    <script th:src="@{../js/echarts.min.js}"></script>
    <script th:src="@{../js/jquery-3.6.0.min.js}"></script>
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/css/animate.min.css}">
    <link rel="stylesheet" th:href="@{/css/magnific-popup.css}">
    <link rel="stylesheet" th:href="@{/css/fontawesome-all.min.css}">
    <link rel="stylesheet" th:href="@{/css/owl.carousel.min.css}">
    <link rel="stylesheet" th:href="@{/css/flaticon.css}">
    <link rel="stylesheet" th:href="@{/css/odometer.css}">
    <link rel="stylesheet" th:href="@{/css/aos.css}">
    <link rel="stylesheet" th:href="@{/css/slick.css}">
    <link rel="stylesheet" th:href="@{/css/default.css}">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/responsive.css}">

</head>
<body>


<style>
    .tablelist{
        /*position: absolute;*/
        display: flex;
        /*border: 1px blue solid;*/
        margin: auto 0;

    }
    .table{
        /*border: 1px red solid;*/
        background-color: rgba(255,255,255,0);
        margin: 0 auto;
    }
    .row{
        display: flex;
        justify-content: center;
    }
    .banner-content{
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 0;
        margin: 0;
    }
</style>
<!--<div id="preloader">-->
<!--    <div id="loading-center">-->
<!--        <div id="loading-center-absolute">-->
<!--            <img src="https://themebeyond.com/html/movflx//img/preloader.svg" alt="">-->
<!--        </div>-->
<!--    </div>-->
<!--</div>-->
<!-- preloader-end -->

<!-- Scroll-top -->
<!--<button class="scroll-top scroll-to-target" data-target="html">-->
<!--    <i class="fas fa-angle-up"></i>-->
<!--</button>-->
<!-- Scroll-top-end-->

<!-- header-area -->
<header>
    <div id="sticky-header" class="menu-area transparent-header">
        <div class="container custom-container">
            <div class="row">
                <div class="col-12">
                    <div class="mobile-nav-toggler"><i class="fas fa-bars"></i></div>
                    <div class="menu-wrap">
                        <nav class="menu-nav show">
                            <div class="logo">
                                <a href="popular.html">
                                    <img src="/img/logo/logo.png" alt="Logo">
                                </a>z
                            </div>
                            <div class="navbar-wrap main-menu d-none d-lg-flex">
                                <ul class="navigation">
                                    <li><a th:href="@{http://localhost:8080/movies/popular?pageNum=1&pageSize=10}">Home</a>
                                    </li>
                                    <li><a th:href="@{http://localhost:8080/movies/genre?genre=科幻&pageNum=1&pageSize=10}">Movie</a>
                                    </li>
                                    <li><a th:href="@{http://localhost:8080/movies/pricing}">Pricing</a></li>
                                    <li><a th:href="@{../contact.html}">contacts</a></li>
                                    <li id="welcome" style="
                                                    font-size: 12px;
                                                    font-weight: 500;
                                                    text-transform: uppercase;
                                                    color: #f0f0f0;
                                                    padding: 38px 23px;
                                                    display: block;
                                                    line-height: 1;
                                                    position: relative;
                                                    z-index: 1;">未登录，请登录</li>
                                </ul>
                            </div>

                            <div class="header-action d-none d-md-block">
                                <ul>
                                    <!--                                            <li class="header-search"><a href="#" data-toggle="modal" data-target="#search-modal"><i class="fas fa-search"></i></a></li>-->
                                    <li id="header-search"><a href="#" ><i class="fas fa-search"></i></a></li>

                                    <div class="layout">
                                        <input type="text" class="search-box">
                                        <button id="search-confirm">确认</button>
                                    </div>

                                    <li class="header-lang">
                                        <form action="#">
                                            <div class="icon"><i class="flaticon-globe"></i></div>
                                            <select id="lang-dropdown">
                                                <option value="">En</option>
                                                <option value="">Au</option>
                                                <option value="">AR</option>
                                                <option value="">TU</option>
                                            </select>
                                        </form>
                                    </li>
                                    <!--                                            <li class="header-btn"><a href="#" class="btn">Sign In</a></li>-->
                                </ul>
                            </div>
                        </nav>
                    </div>

                    <style>
                        .layout{
                            width: 100vw;
                            height: 100vh;
                            background-color: rgba(0, 0, 0, 0.6);
                            transition: 0.5s linear;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            position: fixed;
                            z-index: 99;
                            top: 0;
                            left: 0;
                            opacity: 0;
                        }
                        #search-confirm{
                            height: 60px;
                            border: none;
                            border-radius: 5px;
                            width: 100px;
                            margin-left: 20px;
                            background-color: rgb(228, 216, 4);
                            color: #fff;
                            font-size: 20px;
                            font-weight: 500;
                        }
                        .search-box{
                            /*border: 1px red solid;*/
                            width: 400px;
                            height: 60px;
                            position: relative;
                            font-weight: 500;
                            font-size: 20px;
                            padding: 0 10px;
                        }
                        .search-box::before{
                            content: '123';
                            position: absolute;
                            right: 0;
                            top: 0;
                            /*border: 1px red solid;*/
                            width: 100px;
                            height: 100px;
                        }
                    </style>
                    <script>

                        const searchIcon = document.querySelector('#header-search');
                        const layout = document.querySelector('.layout');
                        const input = document.querySelector('.search-box');
                        const button = document.querySelector('#search-confirm');
                        const type = ["科幻", "剧情", "犯罪", "喜剧", "爱情", "奇幻", "战争", "音乐"];
                        const welcome = document.querySelector('#welcome');
                        const container = document.querySelector('.header-action.d-none.d-md-block').children[0];

                        layout.addEventListener('click', (event)=>{
                            // layout.style.display = 'none';
                            layout.style.opacity = 0;
                            layout.style.pointerEvents = 'none';

                        })

                        input.addEventListener('click', (event)=>{
                            event.stopPropagation();
                        })
                        button.addEventListener('click', (event)=>{
                            event.stopPropagation();
                            if (type.indexOf(input.value) === -1){
                                location.href = 'http://localhost:8080/movies/searchByName?name=' + input.value;
                            } else{
                                location.href = 'http://localhost:8080/movies/genre?genre=' + input.value + '&pageNum=1&pageSize=10';
                            }
                        })
                        searchIcon.addEventListener('click', ()=>{
                            layout.style.opacity = 1;
                            layout.style.pointerEvents = 'auto';
                        })

                        function check_status(){
                            const container = document.querySelector('.header-action.d-none.d-md-block').children[0];
                            fetch('http://localhost:8080/user/check')
                                .then(response => response.text())
                                .then(data => {
                                    if(data !== "用户未登陆") {
                                        fetch('http://localhost:8080/user/is_vip')
                                            .then(response => response.text())
                                            .then(data => {
                                                if(data === "true") {
                                                    welcome.innerText = "欢迎！VIP用户！"
                                                    // console.log(container)
                                                    container.removeChild(container.lastChild);
                                                    container.appendChild(createLi("退出登录"));
                                                }
                                                else {
                                                    welcome.innerText = "欢迎！普通用户！"
                                                    container.removeChild(container.lastChild)
                                                    container.appendChild(createLi("退出登录"));
                                                }
                                            })
                                            .catch(error => console.error('Error:', error));
                                    }
                                    else {
                                        welcome.innerText = "未登录！请登录！"
                                        container.removeChild(container.lastChild)
                                        container.appendChild(createLi("登录/注册"));
                                    }
                                })
                                .catch(error => console.error('Error:', error));
                        }
                        window.onload = () => {
                            check_status();
                        }
                        // check_status();

                        function createLi (text){
                            const li = document.createElement('li')
                            const a = document.createElement('a')
                            li.classList.add('header-btn')

                            fetch('http://localhost:8080/user/check')
                                .then(response => response.text())
                                .then(data => {
                                    if(data === "用户已登录"){
                                        console.log(data);
                                        li.removeEventListener('click', create_login);
                                        li.addEventListener('click', create_logout);
                                    } else{
                                        console.log(data);
                                        li.removeEventListener('click', create_logout);
                                        li.addEventListener('click', create_login);
                                    }
                                })
                                .catch(error => console.error('Error:', error));

                            a.href = '#'
                            a.classList.add('btn')
                            a.innerText = text;
                            li.appendChild(a);
                            return li
                        }


                        const loginBody = {
                            "username": "sjh",
                            "password": 123,
                        };

                        const loginvipBody = {
                            "username": "jc",
                            "password": 123,
                        };

                        const registerBody = {
                            "username": "sjh",
                            "password": 123,
                            "email": "1234567@qq.com",
                            "isVip": false
                        };

                        let target = loginBody;

                        function create_login(){
                            console.log("in");
                            if(target === loginvipBody) target = loginBody;
                            else target = loginvipBody;
                            // 发送请求
                            fetch('http://localhost:8080/user/login', {
                                method: 'POST', // 指定请求方法为POST
                                headers: {
                                    'Content-Type': 'application/json' // 设置请求头，指定内容类型为JSON
                                },
                                body: JSON.stringify(target) // 将请求体转换为JSON字符串
                            })
                                .then(response => response.text()) // 解析响应体为JSON格式
                                .then(data => {
                                    console.log(data); // 处理响应数据
                                    if (data === "登录成功"){
                                        fetch('http://localhost:8080/user/is_vip')
                                            .then(response => response.text())
                                            .then(data => {
                                                if(data === "true") {
                                                    welcome.innerText = '欢迎！VIP用户！';

                                                }
                                                else {
                                                    welcome.innerText = '欢迎！普通用户！';
                                                }
                                            })
                                            .catch(error => console.error('Error:', error));
                                        container.removeChild(container.lastChild)
                                        container.appendChild(createLi("退出登录"));

                                    }else{
                                        console.log(data);
                                        welcome.innerText = '未登录，请登录';
                                        console.warn("不存在该用户！请注册！")

                                        fetch('http://localhost:8080/user/register', {
                                            method: 'POST', // 指定请求方法为POST
                                            headers: {
                                                'Content-Type': 'application/json' // 设置请求头，指定内容类型为JSON
                                            },
                                            body: JSON.stringify(registerBody) // 将请求体转换为JSON字符串
                                        })
                                            .then(response => response.text()) // 解析响应体为JSON格式
                                            .then(data => {
                                                console.log(data); // 处理响应数据
                                            })
                                            .catch(error => {
                                                console.error('Error:', error); // 处理错误
                                            });

                                        container.removeChild(container.lastChild)
                                        container.appendChild(createLi("登录/注册"));
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error); // 处理错误
                                });

                        }

                        function create_logout(){
                            console.log("out");
                            const btn = document.querySelector('.header-btn');

                            // fetch('http://localhost:8080/user/logout')
                            //     .then(response => response.text())
                            //     .then(data => {
                            //         console.log(data);
                            //         welcome.innerText = "未登录！请登录！"
                            //         container.removeChild(container.lastChild)
                            //         container.appendChild(createLi("登录/注册"));
                            //     })
                            //     .catch(error => console.error('Error:', error));

                            // 创建一个对象来表示请求体
                            const requestBody = {
                                username: "jc",
                                password: 123,
                                email: "12345@qq.com",
                                isVip: true
                            };

                            // 使用fetch API发送POST请求
                            fetch('http://localhost:8080/user/logout', {
                                method: 'POST', // 指定请求方法为POST
                                headers: {
                                    'Content-Type': 'application/json', // 设置请求头，表明发送的是JSON数据
                                },
                                body: JSON.stringify(requestBody) // 将请求体对象转换为JSON字符串
                            })
                                .then(response => response.text()) // 解析响应体为JSON
                                .then(data => {
                                    console.log(data);
                                    welcome.innerText = "未登录！请登录！"
                                    container.removeChild(container.lastChild)
                                    container.appendChild(createLi("登录/注册"));
                                })
                                .catch(error => {
                                    console.error('Error:', error); // 捕获并打印错误信息
                                });


                        }

                        // console.log(localStorage.getItem('islogin'))
                        // const btn = document.querySelector('.header-btn');
                        // // 判定登录状态
                        // if(localStorage.getItem('islogin')) btn.addEventListener('click', create_login);
                        // else btn.addEventListener('click', create_logout);

                    </script>

                    <!-- Mobile Menu  -->
                    <div class="mobile-menu">
                        <div class="close-btn"><i class="fas fa-times"></i></div>

                        <nav class="menu-box">
                            <div class="nav-logo"><a href="popular.html"><img src="/img/logo/logo.png" alt="" title=""></a>
                            </div>
                            <div class="menu-outer">
                                <!--Here Menu Will Come Automatically Via Javascript / Same Menu as in Header-->
                            </div>
                            <div class="social-links">
                                <ul class="clearfix">
                                    <li><a href="#"><span class="fab fa-twitter"></span></a></li>
                                    <li><a href="#"><span class="fab fa-facebook-square"></span></a></li>
                                    <li><a href="#"><span class="fab fa-pinterest-p"></span></a></li>
                                    <li><a href="#"><span class="fab fa-instagram"></span></a></li>
                                    <li><a href="#"><span class="fab fa-youtube"></span></a></li>
                                </ul>
                            </div>
                        </nav>
                    </div>
                    <div class="menu-backdrop"></div>
                    <!-- End Mobile Menu -->

                    <!-- Modal Search -->
                    <div class="modal fade" id="search-modal" tabindex="-1" role="dialog" aria-hidden="true">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <form id="search-form">
                                    <input type="text" placeholder="Search here...">
                                    <button onclick="performSearch()"><i class="fas fa-search"></i></button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <!-- Modal Search-end -->

                    <script>
                        function performSearch(e) {

                            e.preventDefault()
                            let searchInput = document.getElementById('search-input').value;
                            let url = '/movies/genre?genre=' + encodeURIComponent(searchInput) + '&pageNum=1&pageSize=10';

                            // window.location.href = url;
                            // return false; // Prevent form submission
                        }
                    </script>

                </div>
            </div>
        </div>
    </div>
</header>
<!-- header-area-end -->

<!-- main-area -->
<main>

    <!-- banner-area -->
    <section class="banner-area banner-bg" data-background="../img/banner/s_slider_bg.jpg">
        <div class="container custom-container">
            <div class="row">
                <div class="banner-content">
                    <div class="tablelist">
                        <div class="table" id="chart1" style="width: 600px; height: 400px;">123</div>
                        <div class="table" id="chart2" style="width: 600px; height: 400px;">123</div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- banner-area-end -->

</main>
<!-- main-area-end -->

<!-- footer-area -->
<footer>
    <div class="footer-top-wrap">
        <div class="container">
            <div class="footer-menu-wrap">
                <div class="row align-items-center">
                    <div class="col-lg-3">
                        <div class="footer-logo">
                            <a href="popular.html"><img src="/img/logo/logo.png" alt=""></a>
                        </div>
                    </div>
                    <div class="col-lg-9">
                        <div class="footer-menu">
                            <nav>
                                <ul class="navigation">
                                    <li><a th:href="@{../popular.html}">主页</a></li>
                                    <li><a th:href="@{../popular.html}">电影</a></li>
                                    <!--                                            <li><a th:href="@{../popular.html}">tv show</a></li>-->
                                    <li><a th:href="@{../popular.html}">页面</a></li>
                                    <li><a th:href="@{http://localhost:8080/api/movies/export}">导出</a></li>
                                </ul>
                                <div class="footer-search">
                                    <form action="#">
                                        <input type="text" placeholder="Find Favorite Movie">
                                        <button><i class="fas fa-search"></i></button>
                                    </form>
                                </div>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            <div class="footer-quick-link-wrap">
                <div class="row align-items-center">
                    <div class="col-md-7">
                        <div class="quick-link-list">
                            <ul>
                                <li><a href="#">FAQ</a></li>
                                <li><a href="#">Help Center</a></li>
                                <li><a href="#">Terms of Use</a></li>
                                <li><a href="#">Privacy</a></li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="footer-social">
                            <ul>
                                <li><a href="#"><i class="fab fa-facebook-f"></i></a></li>
                                <li><a href="#"><i class="fab fa-twitter"></i></a></li>
                                <li><a href="#"><i class="fab fa-pinterest-p"></i></a></li>
                                <li><a href="#"><i class="fab fa-linkedin-in"></i></a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="copyright-wrap">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 col-md-6">
                    <div class="copyright-text">
                        <p>Copyright &copy; 2021. All Rights Reserved By <a href="http://www.bootstrapmb.com/">bootstrapmb</a></p>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6">
                    <div class="payment-method-img text-center text-md-right">
                        <img src="/img/images/card_img.png" alt="img">
                    </div>
                </div>
            </div>
        </div>
    </div>
</footer>
<script>
    $(document).ready(function() {
        $.get('/api/movies/all', function(data) {
            console.log(data);
            // Parse data to use in charts
            let titles = data.map(movie => movie.title);
            let weeklyPlays = data.map(movie => movie.weeklyPlays);

            // Initialize charts
            let chart1 = echarts.init(document.getElementById('chart1'));
            let chart2 = echarts.init(document.getElementById('chart2'));

            // Chart 1: Bar chart for weekly plays
            let option1 = {
                title: { text: 'Weekly Plays' },
                xAxis: { type: 'category', data: titles },
                yAxis: { type: 'value' },
                series: [{ data: weeklyPlays, type: 'bar' }]
            };
            chart1.setOption(option1);

            // Chart 2: Pie chart for genres
            let genres = {};
            data.forEach(movie => {
                genres[movie.genre] = (genres[movie.genre] || 0) + 1;
            });
            let genreData = Object.keys(genres).map(key => ({ value: genres[key], name: key }));

            let option2 = {
                title: { text: 'Genres Distribution' },
                series: [{
                    name: 'Genres',
                    type: 'pie',
                    data: genreData
                }]
            };
            chart2.setOption(option2);
        });
    });
</script>

<script th:src="@{/js/vendor/jquery-3.6.0.min.js}"></script>
<script th:src="@{/js/bootstrap.min.js}"></script>
<script th:src="@{/js/popper.min.js}"></script>
<script th:src="@{/js/owl.carousel.min.js}"></script>
<script th:src="@{/js/isotope.pkgd.min.js}"></script>
<script th:src="@{/js/aos.js}"></script>
<script th:src="@{/js/slick.min.js}"></script>
<script th:src="@{/js/ajax-form.js}"></script>
<script th:src="@{/js/jquery.odometer.min.js}"></script>
<script th:src="@{/js/wow.min.js}"></script>
<script th:src="@{/js/jquery.appear.js}"></script>
<script th:src="@{/js/imagesloaded.pkgd.min.js}"></script>
<script th:src="@{/js/jquery.magnific-popup.min.js}"></script>
<script th:src="@{/js/plugins.js}"></script>
<script th:src="@{/js/main.js}"></script>

</body>
</html>
